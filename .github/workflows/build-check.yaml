name: Build Check

on:
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Poetry
        uses: abatilo/actions-poetry@v4

      - name: Build .NET Plugin
        run: |
          Set-Location .\src\FanControl.Liquidctl
          dotnet build --configuration Debug
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå .NET build failed!" -ForegroundColor Red
            exit 1
          }
          Write-Host "‚úÖ .NET build successful!" -ForegroundColor Green

      - name: Install Python Dependencies
        run: |
          Set-Location .\src\Liquidctl.Bridge
          poetry install
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Poetry install failed!" -ForegroundColor Red
            exit 1
          }
          Write-Host "‚úÖ Python dependencies installed!" -ForegroundColor Green

      - name: Build Python Bridge
        run: |
          Set-Location .\src\Liquidctl.Bridge
          poetry run pyinstaller --onefile ".\liquidctl_bridge\server.py" -n liquidctl_bridge --clean
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Python bridge build failed!" -ForegroundColor Red
            exit 1
          }
          Write-Host "‚úÖ Python bridge build successful!" -ForegroundColor Green

      - name: Verify Build Artifacts
        run: |
          $dllPath = ".\src\FanControl.Liquidctl\bin\Debug\net8.0\FanControl.Liquidctl.dll"
          $exePath = ".\src\Liquidctl.Bridge\dist\liquidctl_bridge.exe"

          if (Test-Path $dllPath) {
            Write-Host "‚úÖ Found .NET plugin: $dllPath" -ForegroundColor Green
          } else {
            Write-Host "‚ùå Missing .NET plugin: $dllPath" -ForegroundColor Red
            exit 1
          }

          if (Test-Path $exePath) {
            Write-Host "‚úÖ Found Python bridge: $exePath" -ForegroundColor Green
          } else {
            Write-Host "‚ùå Missing Python bridge: $exePath" -ForegroundColor Red
            exit 1
          }

          Write-Host ""
          Write-Host "üéâ All build artifacts verified successfully!" -ForegroundColor Green
